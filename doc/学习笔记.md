# mini-claw 学习笔记

通过动手实现一个简化版 OpenClaw，理解 AI Agent 框架的核心架构。

---

## 一、OpenClaw 是什么

OpenClaw 是一个**常驻在自己电脑上的个人 AI 助手**。

和 ChatGPT / Claude.ai 的本质区别：

| | ChatGPT / Claude.ai | OpenClaw |
|--|--|--|
| 运行位置 | 云端（别人的服务器） | 自己的机器 |
| 使用方式 | 主动打开网页/app | 常驻后台，随时触发 |
| 能操控电脑吗 | 不能 | 能（shell、文件、浏览器） |
| 跨平台接入 | 只有网页/app | Telegram/WhatsApp/Discord... |
| 数据隐私 | 上传给服务商 | 全在本地 |

和 Claude Code 的区别：

- **Claude Code**：你坐在电脑前，主动打开，给 AI 下指令
- **OpenClaw**：AI 常驻后台，你在任何地方用手机发消息就能触发

---

## 二、OpenClaw 的三层架构

```
触发层   ← 最独特的部分，常驻后台 + 多平台消息接入
   ↓
执行层   ← 和 Claude Code 大差不差，工具调用（shell、文件、浏览器）
   ↓
管理层   ← 会话、历史、并发、定时任务（部分是触发层配套的）
```

**触发层是核心护城河**：不靠人打开窗口，不靠打开浏览器，
消息从 Telegram / WhatsApp 等平台进来，Agent 在后台处理完，结果发回去。

---

## 三、mini-claw 的架构对应

mini-claw 是 OpenClaw 的极简学习版，麻雀虽小五脏俱全：

```
Telegram 消息
     ↓
telegram_channel.py   ← 对应 OpenClaw: extensions/telegram/
     ↓                   职责：接收消息、安全检查、发送回复
gateway.py            ← 对应 OpenClaw: src/gateway/server.ts
     ↓                   职责：路由消息到 Agent，管理会话
agent.py              ← 对应 OpenClaw: src/agents/
     ↓                   职责：LLM 调用，Agentic Loop
tools.py              ← 对应 OpenClaw: 工具系统
                         职责：Agent 可调用的能力（只读）
```

---

## 四、安全设计

### 4.1 只读工具原则

mini-claw 只开放两个只读工具，危险操作全部关闭：

| 工具 | 操作 | 说明 |
|------|------|------|
| `read_file` | 读 | 读取文件内容 |
| `list_files` | 读 | 列出目录结构 |
| `write_file` | ❌ 关闭 | 太危险 |
| `execute_code` | ❌ 关闭 | 太危险 |

OpenClaw 里也有类似机制：危险命令需要用户预先审批加入白名单才能执行。
本质上都是"给 Agent 的权限要最小化"原则。

### 4.2 Workspace 路径边界

**问题**：即使只有 `read_file`，如果不限制路径，
Agent 可以读 `.env`（里面有所有 API key）、SSH 私钥、系统文件...

**解决方案**：在 `.env` 里配置 `WORKSPACE_PATH`，
`read_file` 和 `list_files` 只能访问这个目录内的文件，出界直接报错。

```
WORKSPACE_PATH=D:\你的workspace目录
```

**关键实现**：用 `os.path.realpath()` 解析路径后再比较，
防止 `../../etc/passwd` 这类路径穿越攻击：

```python
def _is_safe_path(path: str) -> bool:
    resolved = os.path.realpath(path)        # 解析掉 ../../../
    return resolved.startswith(_WORKSPACE)   # 必须在 workspace 内
```

对应 OpenClaw：Agent 的 workspace 边界限制，`src/agents/agent-scope.ts`。

### 4.3 Chat ID 白名单

只有配置的 `TELEGRAM_ALLOWED_CHAT_ID` 发来的消息才会被处理，
其他人发消息给 bot 一律拒绝。

```
TELEGRAM_ALLOWED_CHAT_ID=你的数字ID
```

对应 OpenClaw：账号绑定（binding）机制，
只有绑定的账号才能触发对应的 Agent。

---

## 五、配置管理：.env 最佳实践

**原则：含真实 key 的文件，绝对不能进 git。**

| 文件 | 进 git？ | 内容 |
|------|---------|------|
| `.env` | ❌ 不进 | 真实的 key 和配置 |
| `.env.example` | ✅ 进 | 只有 key 的名字，没有值 |

`.env` 里需要配置的内容：

```
ANTHROPIC_API_KEY=sk-ant-xxx       # Anthropic API key
TELEGRAM_BOT_TOKEN=7123:AAF-xxx    # BotFather 给的 Bot token
TELEGRAM_ALLOWED_CHAT_ID=123456789 # 自己的 Telegram Chat ID
WORKSPACE_PATH=D:\你的workspace     # Agent 只能访问这个目录
```

代码里通过 `python-dotenv` 读取：

```python
from dotenv import load_dotenv
import os

load_dotenv()
ANTHROPIC_API_KEY = os.environ.get("ANTHROPIC_API_KEY")
```

---

## 六、待实现

- [ ] `telegram_channel.py` — Telegram 频道适配器
- [ ] `gateway.py` — 主循环，消息路由
- [ ] 持久化会话历史（目前是内存，重启丢失）
